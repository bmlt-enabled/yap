<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yap Communication Widget Demo</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin-bottom: 40px;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .demo-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .demo-section h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.25rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .widget-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .code-block .comment {
            color: #6a9955;
        }

        .code-block .tag {
            color: #569cd6;
        }

        .code-block .attr {
            color: #9cdcfe;
        }

        .code-block .string {
            color: #ce9178;
        }

        .info-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .info-box h3 {
            margin: 0 0 10px 0;
            color: #0369a1;
            font-size: 1rem;
        }

        .info-box ul {
            margin: 0;
            padding-left: 20px;
            color: #0c4a6e;
        }

        .info-box li {
            margin: 5px 0;
        }

        .warning-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .warning-box h3 {
            margin: 0 0 10px 0;
            color: #b45309;
            font-size: 1rem;
        }

        .warning-box p {
            margin: 0;
            color: #92400e;
        }

        .success-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            display: none;
        }

        .success-box h3 {
            margin: 0 0 10px 0;
            color: #166534;
            font-size: 1rem;
        }

        .success-box p {
            margin: 0;
            color: #15803d;
        }

        .status-checking {
            text-align: center;
            color: #666;
            padding: 10px;
        }

        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            padding: 20px;
        }

        .footer a {
            color: white;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #f0f0ff;
        }

        .feature-status {
            display: flex;
            gap: 16px;
            margin-top: 10px;
        }

        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .feature-badge.enabled {
            background: #dcfce7;
            color: #166534;
        }

        .feature-badge.disabled {
            background: #fee2e2;
            color: #991b1b;
        }

        .feature-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .feature-dot.enabled {
            background: #22c55e;
        }

        .feature-dot.disabled {
            background: #ef4444;
        }

        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Yap Communication Widget</h1>
        <p class="subtitle">Enable browser-based calling and chat on your website</p>

        <div class="demo-grid">
            <!-- Live Demo - Combined Widget -->
            <div class="demo-section">
                <h2>Live Demo - Combined Widget</h2>
                <p>Includes both Call and Chat tabs (when enabled)</p>
                <div class="widget-container">
                    <div
                        id="demo-widget-combined"
                        data-yap-widget
                        data-yap-api-url=""
                        data-yap-title="NA Helpline"
                        data-yap-show-location="true"
                    ></div>
                </div>

                <div id="status-checking" class="status-checking">
                    Checking configuration...
                </div>

                <div id="feature-status" class="feature-status" style="display: none;">
                    <span id="call-badge" class="feature-badge disabled">
                        <span class="feature-dot disabled"></span>
                        Call
                    </span>
                    <span id="chat-badge" class="feature-badge disabled">
                        <span class="feature-dot disabled"></span>
                        Chat
                    </span>
                </div>

                <div id="success-box" class="success-box">
                    <h3>Ready to Use</h3>
                    <p>The widget is configured and ready. Try it out above!</p>
                </div>

                <div id="warning-box" class="warning-box" style="display: none;">
                    <h3>Configuration Required</h3>
                    <p>See the setup instructions below to enable calling and/or chat.</p>
                </div>
            </div>

            <!-- Call-Only Widget -->
            <div class="demo-section">
                <h2>Call-Only Widget</h2>
                <p>WebRTC browser-based calling only:</p>

                <div class="widget-container">
                    <div
                        id="demo-widget-call"
                        data-yap-widget="call"
                        data-yap-api-url=""
                        data-yap-title="Call Helpline"
                        data-yap-show-location="true"
                    ></div>
                </div>

                <div class="code-block">
<span class="comment">&lt;!-- Call-only widget --&gt;</span>
<span class="tag">&lt;div</span>
    <span class="attr">data-yap-widget</span>=<span class="string">"call"</span>
    <span class="attr">data-yap-api-url</span>=<span class="string">"https://your-yap-server.com"</span>
<span class="tag">&gt;&lt;/div&gt;</span>
                </div>
            </div>

            <!-- Chat-Only Widget -->
            <div class="demo-section">
                <h2>Chat-Only Widget</h2>
                <p>Text chat with volunteers via SMS bridge:</p>

                <div class="widget-container">
                    <div
                        id="demo-widget-chat"
                        data-yap-widget="chat"
                        data-yap-api-url=""
                        data-yap-title="Chat with a Volunteer"
                    ></div>
                </div>

                <div class="code-block">
<span class="comment">&lt;!-- Chat-only widget --&gt;</span>
<span class="tag">&lt;div</span>
    <span class="attr">data-yap-widget</span>=<span class="string">"chat"</span>
    <span class="attr">data-yap-api-url</span>=<span class="string">"https://your-yap-server.com"</span>
<span class="tag">&gt;&lt;/div&gt;</span>
                </div>
            </div>

            <!-- Simple Embed -->
            <div class="demo-section">
                <h2>Simple Embed (Data Attributes)</h2>
                <p>The easiest way to add the widget to your site:</p>

                <div class="code-block">
<span class="comment">&lt;!-- Add the widget container --&gt;</span>
<span class="tag">&lt;div</span>
    <span class="attr">data-yap-widget</span>
    <span class="attr">data-yap-api-url</span>=<span class="string">"https://your-yap-server.com"</span>
    <span class="attr">data-yap-title</span>=<span class="string">"NA Helpline"</span>
<span class="tag">&gt;&lt;/div&gt;</span>

<span class="comment">&lt;!-- Load the widget script --&gt;</span>
<span class="tag">&lt;script</span> <span class="attr">src</span>=<span class="string">"https://your-yap-server.com/widget-loader.js"</span><span class="tag">&gt;&lt;/script&gt;</span>
                </div>

                <div class="info-box">
                    <h3>Available Data Attributes</h3>
                    <ul>
                        <li><code>data-yap-widget</code> - Widget type: (empty), "call", "chat", or "combined"</li>
                        <li><code>data-yap-api-url</code> - Your Yap server URL (required)</li>
                        <li><code>data-yap-service-body</code> - Service body ID to route calls</li>
                        <li><code>data-yap-title</code> - Custom widget title</li>
                        <li><code>data-yap-default-tab</code> - Default tab: "call" or "chat"</li>
                        <li><code>data-yap-show-call</code> - Show call tab (true/false)</li>
                        <li><code>data-yap-show-chat</code> - Show chat tab (true/false)</li>
                        <li><code>data-yap-show-location</code> - Show location input (true/false)</li>
                        <li><code>data-yap-show-search-type</code> - Show search type selector (true/false)</li>
                    </ul>
                </div>
            </div>

            <!-- Programmatic Usage -->
            <div class="demo-section">
                <h2>Programmatic Initialization</h2>
                <p>For more control, initialize the widget with JavaScript:</p>

                <div class="code-block">
<span class="tag">&lt;div</span> <span class="attr">id</span>=<span class="string">"my-widget"</span><span class="tag">&gt;&lt;/div&gt;</span>

<span class="tag">&lt;script</span> <span class="attr">src</span>=<span class="string">"https://your-yap-server.com/widget-loader.js"</span><span class="tag">&gt;&lt;/script&gt;</span>
<span class="tag">&lt;script&gt;</span>
<span class="comment">// Combined widget with tabs</span>
YapWidget.load({
    container: <span class="string">'#my-widget'</span>,
    apiUrl: <span class="string">'https://your-yap-server.com'</span>,
    type: <span class="string">'combined'</span>, <span class="comment">// 'call', 'chat', or 'combined'</span>
    serviceBodyId: <span class="string">'123'</span>,
    title: <span class="string">'NA Helpline'</span>,
    defaultTab: <span class="string">'call'</span>,
    onCallStart: <span class="string">function</span>() {
        console.log(<span class="string">'Call started'</span>);
    },
    onCallEnd: <span class="string">function</span>(data) {
        console.log(<span class="string">'Call ended'</span>, data);
    },
    onChatStart: <span class="string">function</span>(sessionId) {
        console.log(<span class="string">'Chat started'</span>, sessionId);
    },
    onChatEnd: <span class="string">function</span>() {
        console.log(<span class="string">'Chat ended'</span>);
    },
    onError: <span class="string">function</span>(error) {
        console.error(<span class="string">'Error'</span>, error);
    }
});

<span class="comment">// Or use specific widget loaders:</span>
<span class="comment">// YapWidget.loadCall({ ... })</span>
<span class="comment">// YapWidget.loadChat({ ... })</span>
<span class="tag">&lt;/script&gt;</span>
                </div>
            </div>

            <!-- Custom Styling -->
            <div class="demo-section">
                <h2>Custom Styling</h2>
                <p>Override the default styles to match your site:</p>

                <div class="code-block">
YapWidget.load({
    container: <span class="string">'#my-widget'</span>,
    apiUrl: <span class="string">'https://your-yap-server.com'</span>,
    styles: {
        container: {
            backgroundColor: <span class="string">'#f5f5f5'</span>,
            borderRadius: <span class="string">'20px'</span>,
            boxShadow: <span class="string">'none'</span>
        },
        callButton: {
            backgroundColor: <span class="string">'#1976d2'</span>
        },
        title: {
            color: <span class="string">'#1976d2'</span>
        }
    }
});
                </div>
            </div>
        </div>

        <!-- Setup Instructions -->
        <div class="demo-section">
            <h2>Setup Instructions</h2>

            <div class="tab-buttons">
                <button class="tab-button active" onclick="showSetupTab('webrtc')">WebRTC Calling Setup</button>
                <button class="tab-button" onclick="showSetupTab('webchat')">Web Chat Setup</button>
            </div>

            <div id="setup-webrtc">
                <p>To enable WebRTC browser-based calling:</p>

                <ol style="color: #333; line-height: 2;">
                    <li>
                        <strong>Create an API Key:</strong>
                        Go to Twilio Console &rarr; Account &rarr; API keys &rarr; Create API Key.
                        Save the SID and Secret.
                    </li>
                    <li>
                        <strong>Create a TwiML Application:</strong>
                        Go to Twilio Console &rarr; Voice &rarr; TwiML Apps &rarr; Create new TwiML App.
                        <ul>
                            <li>Set the Voice Request URL to: <code>https://your-yap-server.com/webrtc-call</code></li>
                            <li>Set the Status Callback URL to: <code>https://your-yap-server.com/webrtc-status</code></li>
                            <li>Save the Application SID</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Add settings to your Yap config.php:</strong>
                        <div class="code-block" style="margin: 10px 0;">
$webrtc_enabled = true;
$twilio_api_key = 'SKxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
$twilio_api_secret = 'your_api_secret_here';
$twilio_twiml_app_sid = 'APxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
                        </div>
                    </li>
                    <li>
                        <strong>Test the widget:</strong>
                        Reload this page and try the Call widget!
                    </li>
                </ol>
            </div>

            <div id="setup-webchat" style="display: none;">
                <p>To enable web chat (text chat bridged via SMS to volunteers):</p>

                <ol style="color: #333; line-height: 2;">
                    <li>
                        <strong>Run the database migration:</strong>
                        <div class="code-block" style="margin: 10px 0;">
php artisan migrate
                        </div>
                        This creates the <code>chat_sessions</code> table.
                    </li>
                    <li>
                        <strong>Configure your SMS webhook (optional):</strong>
                        If volunteers will reply via SMS, configure your Twilio number's SMS webhook to:
                        <code>https://your-yap-server.com/webchat-sms</code>
                    </li>
                    <li>
                        <strong>Add settings to your Yap config.php:</strong>
                        <div class="code-block" style="margin: 10px 0;">
$webchat_enabled = true;

<span class="comment">// Optional customization:</span>
$webchat_timeout_minutes = 30;        <span class="comment">// Session timeout</span>
$webchat_no_volunteers_message = 'Sorry, no volunteers are available.';
$webchat_no_coverage_message = 'Sorry, there is no coverage for your location.';
                        </div>
                    </li>
                    <li>
                        <strong>Test the widget:</strong>
                        Reload this page and try the Chat widget!
                    </li>
                </ol>

                <div class="info-box">
                    <h3>How Web Chat Works</h3>
                    <ul>
                        <li>User enters location and message in the web widget</li>
                        <li>System finds active volunteers for that area and sends SMS to all (blasting)</li>
                        <li>First volunteer to reply claims the session</li>
                        <li>Messages are bridged: web user &harr; server &harr; volunteer's SMS</li>
                        <li>Session ends after 30 min inactivity or when either party ends it</li>
                        <li>Sessions persist on page refresh but not across browser sessions</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>
                Yap Communication Widget |
                <a href="https://github.com/bmlt-enabled/yap" target="_blank">GitHub</a> |
                <a href="https://yap.bmlt.app" target="_blank">Documentation</a>
            </p>
        </div>
    </div>

    <!-- Load the widget -->
    <script>
        // Check configuration status
        async function checkConfig() {
            var statusChecking = document.getElementById('status-checking');
            var successBox = document.getElementById('success-box');
            var warningBox = document.getElementById('warning-box');
            var featureStatus = document.getElementById('feature-status');
            var callBadge = document.getElementById('call-badge');
            var chatBadge = document.getElementById('chat-badge');

            var callEnabled = false;
            var chatEnabled = false;

            // Check WebRTC
            try {
                var webrtcResponse = await fetch(window.location.origin + '/api/v1/webrtc/config');
                var webrtcData = await webrtcResponse.json();
                callEnabled = webrtcResponse.ok && webrtcData.enabled;
            } catch (error) {
                callEnabled = false;
            }

            // Check WebChat
            try {
                var webchatResponse = await fetch(window.location.origin + '/api/v1/webchat/config');
                var webchatData = await webchatResponse.json();
                chatEnabled = webchatResponse.ok && webchatData.enabled;
            } catch (error) {
                chatEnabled = false;
            }

            statusChecking.style.display = 'none';
            featureStatus.style.display = 'flex';

            // Update badges
            if (callEnabled) {
                callBadge.className = 'feature-badge enabled';
                callBadge.querySelector('.feature-dot').className = 'feature-dot enabled';
            }
            if (chatEnabled) {
                chatBadge.className = 'feature-badge enabled';
                chatBadge.querySelector('.feature-dot').className = 'feature-dot enabled';
            }

            if (callEnabled || chatEnabled) {
                successBox.style.display = 'block';
                warningBox.style.display = 'none';
            } else {
                successBox.style.display = 'none';
                warningBox.style.display = 'block';
            }
        }

        // Show setup tab
        function showSetupTab(tab) {
            var buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(function(btn) { btn.classList.remove('active'); });
            event.target.classList.add('active');

            document.getElementById('setup-webrtc').style.display = tab === 'webrtc' ? 'block' : 'none';
            document.getElementById('setup-webchat').style.display = tab === 'webchat' ? 'block' : 'none';
        }

        // Set the API URL dynamically before widget-loader.js runs
        (function() {
            var widgets = document.querySelectorAll('[data-yap-widget]');
            widgets.forEach(function(widget) {
                widget.setAttribute('data-yap-api-url', window.location.origin);
            });
        })();

        // Check config status on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkConfig);
        } else {
            checkConfig();
        }
    </script>
    <script src="widget-loader.js"></script>
</body>
</html>
